<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<style>
    .layui-btn:not(.layui-btn-lg ):not(.layui-btn-sm):not(.layui-btn-xs) {height:34px;line-height:34px;padding:0 8px;}
</style>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet"/>
</head>
<body>
<!--自定义toolBar-->
<div style="display: none;" id="menu_tool_bar">
    <!--按钮组-->
    <div class="layui-btn-group">
        <!--可以加layui-btn-sm属性控制按钮的大小-->
        <button type="button" class="layui-btn" lay-event="create">创建菜单</button>
    </div>
</div>
<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">
        <div>
            <div class="layui-btn-group">
                <button class="layui-btn" id="btn-expand">全部展开</button>
                <button class="layui-btn layui-btn-normal" id="btn-fold">全部折叠</button>
            </div>
            <table id="munu-table" class="layui-table" lay-filter="munu_table"></table>
        </div>
    </div>
</div>
<!--创建菜单-->
<div id="create_popup" style="display: none;">
    <div class="layui-form layuimini-form" lay-filter="create_popup">
        <div class="layui-form-item">
            <label class="layui-form-label required">菜单名称</label>
            <div class="layui-input-block">
                <input type="text" name="name" lay-verify="required" lay-reqtext="菜单名称不能为空" placeholder="请输入菜单名称" value="" class="layui-input"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">排序号</label>
            <div class="layui-input-block">
                <input type="text" name="sort" lay-verify="required" lay-reqtext="排序号不能为空" placeholder="请输入排序号" value="" class="layui-input"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">菜单url</label>
            <div class="layui-input-block">
                <input type="text" name="url" lay-verify="required" lay-reqtext="url不能为空" placeholder="请输入url" value="" class="layui-input"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">类型</label>
            <input type="radio" name="type" id="type0" value = "0" title="目录" checked=""/>
            <input type="radio" name="type" id="type3" value = "3" title="导航菜单"/>
            <input type="radio" name="type" id="type1" value = "1" title="菜单"/>
            <input type="radio" name="type" id="type2" value = "2" title="按钮"/>
        </div>
    </div>
</div>
<!-- 操作列 -->
<script type="text/html" id="auth-state">
    {{# if(d.type == 0 || d.type == 1 || d.type == 3){ }}
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="add">添加</a>
    {{# } }}
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script th:src="@{/layui/layui.js}" charset="utf-8"></script>
<script>
   layui.extend({
        treetable:'treetable-lay/treetable'
    }).use(['table', 'treetable','form','jquery'], function () {
        var $ = layui.jquery;
        var table = layui.table;
        var treetable = layui.treetable;
        var form = layui.form;

        // 渲染表格
        layer.load(2);
        treetable.render({
            toolbar: '#menu_tool_bar', //开启工具栏，默认default
            treeColIndex: 1,
            treeSpid: -1,
            //treeIdName: 'authorityId',
            treeIdName: 'id',
            treePidName: 'parentId',
            elem: '#munu-table',
            //url: 'api/menus.json',
            url: '/menu/query',
            page: false,
            cols: [
                [
                    {type: 'numbers'},
                    {field: 'name',minWidth:150, title: '菜单名称'},
                    {field: 'url', minWidth:150,title: '菜单url'},
                    {field: 'permission', title: '权限'},
                    {field: 'type', title: '类型', templet:function (res) {
                            if (res.type == 0) {
                                return '<span class="layui-badge layui-bg-blue">目录</span>';
                            }else if (res.type == 1) {
                                return '<span class="layui-badge layui-bg-gray">菜单</span>';
                            } else if (res.type == 2) {
                                return '<span class="layui-badge layui-bg-gray">按钮</span>';
                            } else {
                                return '<span class="layui-badge-rim">导航菜单</span>';
                            }
                        }
                    },
                    {field: 'icon', title: '图标'},
                    {field: 'status', title: '状态'},
                    {field: 'sort', title: '排序'},
                    {field: 'createBy', title: '创建人'},
                    {field: 'createTime',minWidth:180 ,title: '创建时间',templet : function (res) {
                            return layui.util.toDateString(res.createTime);
                        }
                    },
                    {templet: '#auth-state', width: 200, align: 'center', title: '操作'}
                ]
            ],
            done: function () {
                layer.closeAll('loading');
            }
        });

        $('#btn-expand').click(function () {
            treetable.expandAll('#munu-table');
        });

        $('#btn-fold').click(function () {
            treetable.foldAll('#munu-table');
        });

        //监听工具条
        table.on('tool(munu_table)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;

            if (layEvent === 'del') {
                layer.msg('删除' + data.id);
            } else if (layEvent === 'edit') {
                layer.msg('修改' + data.id);
            }else if(layEvent === 'add'){

            }
        });

        //监听table头工具栏事件，对应table中的lay-filter属性
        table.on('toolbar(munu_table)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id);
            var data = checkStatus.data; //获取选中的数据
            var layEvent = obj.event;
            if(layEvent === 'create'){
                //创建菜单
                var parentIndex = parent.layer.open({
                    title: "添加菜单",
                    type: 1,//打开一个弹框
                    shade: 0.2,
                    maxmin: true,
                    shadeClose: true,
                    area: ['50%','50%'],
                    content: $("#create_popup"),
                    success: function(layero){
                        //layero是弹层的DOM对象
                        //将菜单和按钮隐藏，这里没有生效
                        $(layero).find("#type1").css('display','none');
                        $(layero).find("#type2").css('display','none');
                        var mask = $(".layui-layer-shade");
                        mask.appendTo(layero.parent());
                        form.render('radio'); //重新渲染
                    }
                    ,btn: ['保存', '取消']
                    ,btnAlign: 'r'//按钮右对齐
                    ,yes: function(index, layero){
                        //按钮一的回调
                        var name = $.trim($(layero).find("input[name='name']").val());
                        var sort = $.trim($(layero).find("input[name='sort']").val());
                        var url = $.trim($(layero).find("input[name='url']").val());
                        var type = $.trim($(layero).find("input[name='type']").val());
                        $.ajax({
                            url: "/menu/add",
                            type: "POST",
                            data: {"name":name,"sort":sort,"url":url,"type":type,"parentId":-1},
                            dataType: "json",
                            traditional: true,
                            success: function (res) {
                                //关闭弹出层
                                if(res.code == 0){
                                    var index = layer.msg("操作成功",{
                                        icon:1,
                                        time:1500//1.5秒关闭
                                    },function () {
                                        // 关闭弹出层
                                        layer.close(index);
                                        layer.close(parentIndex);
                                        //重新加载
                                        parent.window.location.reload();
                                    });
                                }
                            }
                        });
                    }
                });
                return false;
            }
        });

    });
</script>
</body>
</html>